(function(){'use strict';var Ve=Math.cos,Ue=Math.sin;function e(e,t){switch(t){case 0:{e.ClearColor=[1-e.ClearColor[0],1-e.ClearColor[1],1-e.ClearColor[2],e.ClearColor[3]],e.GL.clearColor(e.ClearColor[0],e.ClearColor[1],e.ClearColor[2],e.ClearColor[3]);break}}}function t(){let e=new Float32Array(16);return e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function r(e,t){let r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],l=t[5],s=t[6],d=t[7],u=t[8],m=t[9],f=t[10],c=t[11],g=t[12],y=t[13],h=t[14],C=t[15],p=r*l-n*o,T=r*s-i*o,W=r*d-a*o,M=n*s-i*l,A=n*d-a*l,L=i*d-a*s,v=u*y-m*g,I=u*h-f*g,x=u*C-c*g,S=m*h-f*y,P=m*C-c*y,V=f*C-c*h,U=p*V-T*P+W*S+M*x-A*I+L*v;return U?(U=1/U,e[0]=(l*V-s*P+d*S)*U,e[1]=(i*P-n*V-a*S)*U,e[2]=(y*L-h*A+C*M)*U,e[3]=(f*A-m*L-c*M)*U,e[4]=(s*x-o*V-d*I)*U,e[5]=(r*V-i*x+a*I)*U,e[6]=(h*W-g*L-C*T)*U,e[7]=(u*L-f*W+c*T)*U,e[8]=(o*P-l*x+d*v)*U,e[9]=(n*x-r*P-a*v)*U,e[10]=(g*A-y*W+C*p)*U,e[11]=(m*W-u*A-c*p)*U,e[12]=(l*I-o*S-s*v)*U,e[13]=(r*S-n*I+i*v)*U,e[14]=(y*T-g*M-h*p)*U,e[15]=(u*M-m*T+f*p)*U,e):null}function n(e,t,r){let n=t[0],i=t[1],a=t[2],o=t[3],l=t[4],s=t[5],d=t[6],u=t[7],m=t[8],f=t[9],c=t[10],g=t[11],y=t[12],h=t[13],C=t[14],p=t[15],T=r[0],W=r[1],M=r[2],A=r[3];return e[0]=T*n+W*l+M*m+A*y,e[1]=T*i+W*s+M*f+A*h,e[2]=T*a+W*d+M*c+A*C,e[3]=T*o+W*u+M*g+A*p,T=r[4],W=r[5],M=r[6],A=r[7],e[4]=T*n+W*l+M*m+A*y,e[5]=T*i+W*s+M*f+A*h,e[6]=T*a+W*d+M*c+A*C,e[7]=T*o+W*u+M*g+A*p,T=r[8],W=r[9],M=r[10],A=r[11],e[8]=T*n+W*l+M*m+A*y,e[9]=T*i+W*s+M*f+A*h,e[10]=T*a+W*d+M*c+A*C,e[11]=T*o+W*u+M*g+A*p,T=r[12],W=r[13],M=r[14],A=r[15],e[12]=T*n+W*l+M*m+A*y,e[13]=T*i+W*s+M*f+A*h,e[14]=T*a+W*d+M*c+A*C,e[15]=T*o+W*u+M*g+A*p,e}function i(e,t,r,n){let i=t[0],a=t[1],o=t[2],l=t[3],s=i+i,d=a+a,u=o+o,m=i*s,f=i*d,c=i*u,g=a*d,y=a*u,h=o*u,C=l*s,p=l*d,T=l*u,W=n[0],M=n[1],A=n[2];return e[0]=(1-(g+h))*W,e[1]=(f+T)*W,e[2]=(c-p)*W,e[3]=0,e[4]=(f-T)*M,e[5]=(1-(m+h))*M,e[6]=(y+C)*M,e[7]=0,e[8]=(c+p)*A,e[9]=(y-C)*A,e[10]=(1-(m+g))*A,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function a(e,t,r,n,i){var a=Math.tan;let o,l=1/a(t/2);return e[0]=l/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(n-i),e[10]=(i+n)*o,e[14]=2*i*n*o):(e[10]=-1,e[14]=-2*n),e}function o(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function l(e=[0,0,0],r=[0,0,0,1],n=[1,1,1]){return(i,a)=>{i.World[a]|=2,i[1][a]={EntityId:a,World:t(),Self:t(),Translation:e,Rotation:r,Scale:n,Children:[],Dirty:!0}}}function*s(e,t,r){e.World[t.EntityId]&1<<r&&(yield e[r][t.EntityId]);for(let n of t.Children)yield*s(e,n,r)}function d(e,t,r){let n=e.createProgram();if(e.attachShader(n,u(e,Ye,t)),e.attachShader(n,u(e,He,r)),e.linkProgram(n),!e.getProgramParameter(n,Fe))throw new Error(e.getProgramInfoLog(n));return n}function u(e,t,r){let n=e.createShader(t);if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,Be))throw new Error(e.getShaderInfoLog(n));return n}function m(e){let t={Mode:Ge,Program:d(e,Ne,Oe),Uniforms:[]};for(let r of["pv","world","color"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function f(e){let t={Mode:Ge,Program:d(e,ke,je),Uniforms:[]};for(let r of["pv","world","self","color","light_count","light_positions","light_details"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function c(e){let t={Mode:Ge,Program:d(e,ze,Qe),Uniforms:[]};for(let r of["pv","world","self","color","light_count","light_positions","light_details"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function g(e){let t={Mode:Ge,Program:d(e,Xe,$e),Uniforms:[]};for(let r of["pv","world","self","color","light_count","light_positions","light_details"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function y(e){let t={Mode:be,Program:d(e,Je,Ze),Uniforms:[]};for(let r of["pv","world","color"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function h(e){let t={Mode:De,Program:d(e,et,tt),Uniforms:[]};for(let r of["pv","world","color"])t.Uniforms.push(e.getUniformLocation(t.Program,r));return t}function C(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function p(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function T(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function W(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function M(e,t){var r=Math.sqrt;let n=t[0],i=t[1],a=t[2],o=n*n+i*i+a*a;return 0<o&&(o=1/r(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function A(e,t,r){let n=t[0],i=t[1],a=t[2],o=r[3]*n+r[7]*i+r[11]*a+r[15];return o=o||1,e[0]=(r[0]*n+r[4]*i+r[8]*a+r[12])/o,e[1]=(r[1]*n+r[5]*i+r[9]*a+r[13])/o,e[2]=(r[2]*n+r[6]*i+r[10]*a+r[14])/o,e}function L(e,t,r){let n=A([],t,r),i=o([],r);return p(e,n,i)}function v(e,r,n,i){let t=r[0],a=r[1],o=r[2];return e[0]=t+i*(n[0]-t),e[1]=a+i*(n[1]-a),e[2]=o+i*(n[2]-o),e}function I(e,t,r){let n=t[0],i=t[1],a=t[2],o=t[3],l=r[0],s=r[1],d=r[2],u=r[3];return e[0]=n*u+o*l+i*d-a*s,e[1]=i*u+o*s+a*l-n*d,e[2]=a*u+o*d+n*s-i*l,e[3]=o*u-n*l-i*s-a*d,e}function x(e,t,r){let n=r/2;return e[0]=Ue(n)*t[0],e[1]=Ue(n)*t[1],e[2]=Ue(n)*t[2],e[3]=Ve(n),e}function S(e,r,n,i){var t=Math.acos;let a,o,l,s,d,u=r[0],m=r[1],f=r[2],c=r[3],g=n[0],y=n[1],h=n[2],C=n[3];return o=u*g+m*y+f*h+c*C,0>o&&(o=-o,g=-g,y=-y,h=-h,C=-C),1-o>rt?(a=t(o),l=Ue(a),s=Ue((1-i)*a)/l,d=Ue(i*a)/l):(s=1-i,d=i),e[0]=s*u+d*g,e[1]=s*m+d*y,e[2]=s*f+d*h,e[3]=s*c+d*C,e}function P(e,t){for(let r=0;r<e.World.length;r++)(e.World[r]&nt)===nt&&V(e,r,t)}function V(e,t,r){let n=e[1][t],i=e[6][t],a=i.Trigger&&i.States[i.Trigger];a&&1&i.Current.Flags&&(i.Current=a,i.Trigger=void 0);let o=null,l=null;for(let n of i.Current.Keyframes)if(i.Current.Time<n.Timestamp){l=n;break}else o=n;if(o&&l){let e=l.Timestamp-o.Timestamp,t=i.Current.Time-o.Timestamp,r=t/e;l.Ease&&(r=l.Ease(r)),o.Translation&&l.Translation&&(v(n.Translation,o.Translation,l.Translation,r),n.Dirty=!0),o.Rotation&&l.Rotation&&(S(n.Rotation,o.Rotation,l.Rotation,r),n.Dirty=!0),o.Scale&&l.Scale&&(v(n.Scale,o.Scale,l.Scale,r),n.Dirty=!0)}let s=i.Current.Time+r;if(s<i.Current.Duration)return void(i.Current.Time=s);if(i.Current.Time=0,4&i.Current.Flags)for(let e of i.Current.Keyframes.reverse())e.Timestamp=i.Current.Duration-e.Timestamp;a?(i.Current=a,i.Trigger=void 0):!(2&i.Current.Flags)&&(i.Current=i.States[1])}function U(e,t,r,n){let i=e.currentTime+n,a=0,o=e.createGain();o.gain.value=(t[0]/9)**3;let l,s;if(t[5]&&(s=e.createOscillator(),s.type=t[5],s.frequency.value=(t[7]/3)**3,l=e.createGain(),l.gain.value=(t[6]+3)**3,s.connect(l)),t[1]){let r=e.createBiquadFilter();r.type=t[1],r.frequency.value=2**t[2],r.Q.value=t[3]**1.5,l&&t[4]&&l.connect(r.detune),o.connect(r),r.connect(e.destination)}else o.connect(e.destination);for(let s of t[8]){let t=e.createGain();t.connect(o);let n=(s[1]/9)**3,d=(s[2]/9)**3,u=(s[3]/9)**3,m=(s[4]/6)**3,f=d+u+m;if(t.gain.setValueAtTime(0,i),t.gain.linearRampToValueAtTime(n,i+d),t.gain.setValueAtTime(n,i+d+u),t.gain.exponentialRampToValueAtTime(1e-5,i+f),s[0]){let n=e.createOscillator();n.type=s[0],n.connect(t),n.detune.value=3*(s[5]-7.5)**3,l&&s[6]&&l.connect(n.detune);let a=440*2**((r-69)/12);if(s[7]){let e=(s[8]/9)**3,t=(s[9]/9)**3,r=(s[10]/6)**3;n.frequency.linearRampToValueAtTime(0,i),n.frequency.linearRampToValueAtTime(a,i+e),n.frequency.setValueAtTime(a,i+e+t),n.frequency.exponentialRampToValueAtTime(1e-5,i+e+t+r)}else n.frequency.setValueAtTime(a,i);n.start(i),n.stop(i+f)}else{let r=e.createBufferSource();r.buffer=b(e),r.loop=!0,r.connect(t),r.start(i),r.stop(i+f)}f>a&&(a=f)}s&&(s.start(i),s.stop(i+a))}function b(e){if(!it){it=e.createBuffer(1,2*e.sampleRate,e.sampleRate);let t=it.getChannelData(0);for(let e=0;e<t.length;e++)t[e]=2*Math.random()-1}return it}function D(e,t){for(let r=0;r<e.World.length;r++)(e.World[r]&at)===at&&G(e,r,t)}function G(e,t,r){let n=e[5][t],i=!n.Current||n.Time>n.Current.Exit;if(n.Trigger&&i){let t=60/(n.Trigger.BPM||120);for(let r of n.Trigger.Tracks)for(let n=0;n<r.Notes.length;n++)r.Notes[n]&&U(e.Audio,r.Instrument,r.Notes[n],n*(t/4));n.Current=n.Trigger,n.Time=0}else n.Time+=r;n.Trigger=n.Idle}function E(e){e.Cameras=[];for(let t=0;t<e.World.length;t++)(e.World[t]&ot)===ot&&_(e,t)}function _(e,t){let i=e[1][t],a=e[3][t];e.Cameras.push(a),r(a.View,i.World),n(a.PV,a.Projection,a.View)}function w(e){let t=[],r=[];for(let n=0;n<e.World.length;n++)if((e.World[n]&lt)===lt){let i=e[1][n],a=e[10][n];a.Collisions=[],a.New?(a.New=!1,H(i,a)):a.Dynamic?(H(i,a),r.push(a)):t.push(a)}for(let n=0;n<r.length;n++)R(r[n],t,t.length),R(r[n],r,n)}function R(e,t,r){for(let n,a=0;a<r;a++)if(n=t[a],B(e,n)){let t=Y(e,n);e.Collisions.push({Other:n,Hit:t}),n.Collisions.push({Other:e,Hit:W([],t)})}}function H(e,t){o(t.Center,e.World);let r,n,a,l,s,d;r=l=t.Center[0],n=s=t.Center[1],a=d=t.Center[2];let u=[];for(let o,m=0;8>m;m++)o=st[m],u[0]=o[0]*t.Size[0],u[1]=o[1]*t.Size[1],u[2]=o[2]*t.Size[2],A(u,u,e.World),u[0]<r&&(r=u[0]),u[0]>l&&(l=u[0]),u[1]<n&&(n=u[1]),u[1]>s&&(s=u[1]),u[2]<a&&(a=u[2]),u[2]>d&&(d=u[2]);t.Min=[r,n,a],t.Max=[l,s,d],t.Half[0]=(l-r)/2,t.Half[1]=(s-n)/2,t.Half[2]=(d-a)/2}function Y(e,t){var r=Math.sign,n=Math.abs;let i=e.Center[0]-t.Center[0],a=e.Half[0]+t.Half[0]-n(i),o=e.Center[1]-t.Center[1],l=e.Half[1]+t.Half[1]-n(o),s=e.Center[2]-t.Center[2],d=e.Half[2]+t.Half[2]-n(s);return a<l&&a<d?[a*r(i),0,0]:l<d?[0,l*r(o),0]:[0,0,d*r(s)]}function B(e,t){return e.Min[0]<t.Max[0]&&e.Max[0]>t.Min[0]&&e.Min[1]<t.Max[1]&&e.Max[1]>t.Min[1]&&e.Min[2]<t.Max[2]&&e.Max[2]>t.Min[2]}function F(e,t,r){return(n,i)=>{dt.has(t)||dt.set(t,q(n.GL,t)),n.World[i]|=4,n[2][i]={Kind:0,Material:e,VAO:dt.get(t),Count:t.Indices.length,Color:r}}}function q(e,t){let r=e.createVertexArray();return e.bindVertexArray(r),e.bindBuffer(we,e.createBuffer()),e.bufferData(we,t.Vertices,Ee),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,Ke,!1,0,0),e.bindBuffer(Re,e.createBuffer()),e.bufferData(Re,t.Indices,Ee),e.bindVertexArray(null),r}function K(e){for(let[t,r]of mt)2&e.World[r.entity]&&e[1][r.entity]===r.anchor||(e.Destroy(r.transform.EntityId),mt.delete(t));for(let t=0;t<e.World.length;t++)2&e.World[t]&&(1024&e.World[t]&&O(e,t),4&e.World[t]||N(e,t))}function N(e,t){let r=e[1][t],n=mt.get(r);if(!n){let n=e.Add({Using:[F(e.Materials[1],ut,[1,0,1,1])]}),i=e[1][n];i.World=r.World,i.Dirty=!1,mt.set(r,{entity:t,anchor:r,transform:i})}}function O(e,t){let r=e[1][t],n=e[10][t],i=mt.get(n);if(!i){let i=e.Add({Translation:n.Center,Scale:T([],n.Half,2),Using:[F(e.Materials[1],ut,[0,1,0,1])]});mt.set(n,{entity:t,anchor:r,transform:e[1][i]})}else n.Dynamic&&(i.transform.Translation=n.Center,T(i.transform.Scale,n.Half,2),i.transform.Dirty=!0)}function k(e,t){ft&&(ft.textContent=(1e3*t).toFixed(1)),ct&&(ct.textContent=(1/t).toFixed())}function j(e){e.Lights=[];for(let t=0;t<e.World.length;t++)(e.World[t]&gt)===gt&&z(e,t)}function z(e,t){e.Lights.push(e[4][t])}function Q(e,t){for(let r=0;r<e.World.length;r++)(e.World[r]&yt)===yt&&X(e,r,t)}function X(e,t,r){let n=e[1][t],i=e[9][t];for(let a of s(e,n,6))a.Trigger||(a.Trigger=i.Directions.length?2:1);if(i.Directions.length){let e=i.Directions.reduce($),t=o([],n.World),a=L([],e,n.World);M(a,a),T(a,a,i.MoveSpeed*r);let l=C([],t,a);n.Parent&&A(l,l,n.Parent.Self),n.Translation=l,n.Dirty=!0,i.Directions=[]}if(i.Yaws.length){let e=i.Yaws.reduce(J);I(n.Rotation,e,n.Rotation),n.Dirty=!0,i.Yaws=[]}if(i.Pitches.length){let e=i.Pitches.reduce(J);I(n.Rotation,n.Rotation,e),n.Dirty=!0,i.Pitches=[]}}function $(e,t){return C(e,e,t)}function J(e,t){return I(e,e,t)}function Z(e,t,r){r&&(r.textContent=t.toFixed(1))}function ee(e,t){for(let r=0;r<e.World.length;r++)(e.World[r]&ht)===ht&&te(e,r,t)}function te(e,t,r){let n=e[1][t],a=e[10][t],o=e[11][t];if(o.Dynamic){n.Dirty=!0,n.Translation[1]+=o.VelY*r,o.VelY+=Ct*r,o.VelY+=o.AccY*r,o.AccY=0;for(let t,r=0;r<a.Collisions.length;r++)t=a.Collisions[r],2048&e.World[t.Other.EntityId]&&(C(n.Translation,n.Translation,t.Hit),(0<t.Hit[1]&&0>o.VelY||0>t.Hit[1]&&0<o.VelY)&&(o.VelY=0))}}function re(e,t){for(let r=0;r<e.World.length;r++)(e.World[r]&pt)===pt&&ne(e,r,t)}function ne(e,t,r){let n=e[8][t];if(n.Move){let r=e[9][t];e.Input.KeyW&&r.Directions.push([0,0,1]),e.Input.KeyA&&r.Directions.push([1,0,0]),e.Input.KeyS&&r.Directions.push([0,0,-1]),e.Input.KeyD&&r.Directions.push([-1,0,0])}if(n.Yaw){let n=e[9][t],i=e.Input.mouse_x*n.RotateSpeed*r;0!==i&&n.Yaws.push(x([],Wt,-i))}if(n.Pitch){let n=e[9][t],i=e.Input.mouse_y*n.RotateSpeed*r;0!==i&&n.Pitches.push(x([],Tt,i))}}function ie(e){e.GL.clear(16640);let t=[],r=[];for(let n=0;n<e.Lights.length;n++){let i=e.Lights[n],a=e[1][i.EntityId],l=o([],a.World);t.push(...l),r.push(...i.Color,i.Intensity)}let n=null;for(let a=0;a<e.World.length;a++)if((e.World[a]&Mt)===Mt){let i=e[1][a],o=e[2][a];if(o.Material!==n)switch(n=o.Material,e.GL.useProgram(n.Program),e.GL.uniformMatrix4fv(n.Uniforms[0],!1,e.Cameras[0].PV),o.Kind){case 1:e.GL.uniform1i(n.Uniforms[4],e.Lights.length),e.GL.uniform3fv(n.Uniforms[5],t),e.GL.uniform4fv(n.Uniforms[6],r);}switch(o.Kind){case 0:ae(e,i,o);break;case 1:oe(e,i,o);}}}function ae(e,t,r){e.GL.uniformMatrix4fv(r.Material.Uniforms[1],!1,t.World),e.GL.uniform4fv(r.Material.Uniforms[2],r.Color),e.GL.bindVertexArray(r.VAO),e.GL.drawElements(r.Material.Mode,r.Count,qe,0),e.GL.bindVertexArray(null)}function oe(e,t,r){e.GL.uniformMatrix4fv(r.Material.Uniforms[1],!1,t.World),e.GL.uniformMatrix4fv(r.Material.Uniforms[2],!1,t.Self),e.GL.uniform4fv(r.Material.Uniforms[3],r.Color),e.GL.bindVertexArray(r.VAO),e.GL.drawElements(r.Material.Mode,r.Count,qe,0),e.GL.bindVertexArray(null)}function le(e){for(let t=0;t<e.World.length;t++)(e.World[t]&At)===At&&se(e[1][t])}function se(e){e.Dirty&&(e.Dirty=!1,de(e),i(e.World,e.Rotation,e.Translation,e.Scale),e.Parent&&n(e.World,e.Parent.World,e.World),r(e.Self,e.World))}function de(e){for(let t of e.Children)t.Dirty=!0,de(t)}function ue(e){for(let t=0;t<e.World.length;t++)(e.World[t]&Lt)===Lt&&me(e,t)}function me(t,r){0<t[10][r].Collisions.length&&e(t,t[12][r].Action)}function fe(e){let t=e.shift();return!1===t||void 0===t?"":Array.isArray(t)?t.join(""):t}function ce(e,...t){return e.reduce((e,r)=>e+fe(t)+r)}function ge(){return ce`
        <button onclick="$(${0})">
            Toggle Clear Color
        </button>
    `}function ye(){return ce`
        <div
            style="
                position: absolute;
                top: 0;
                background-color: #000;
                color: #fff;
            "
        >
            ${ge()}
        </div>
    `}function he(){let e=ye();e!==vt&&(It.innerHTML=vt=e)}function Ce(e){return-(Ve(Math.PI*e)-1)/2}function pe(e,r,n,i){return(o,l)=>{o.World[l]|=8,o[3][l]={Projection:a(t(),r,e,n,i),View:t(),PV:t()}}}function Te(e=3.5,t=.5){return(r,n)=>{r.World[n]|=512,r[9][n]={MoveSpeed:e,RotateSpeed:t,Directions:[],Yaws:[],Pitches:[]}}}function We(e,t,r){return(n,i)=>{n.World[i]|=256,n[8][i]={Move:e,Yaw:t,Pitch:r}}}function Me(e){return{Rotation:[0,1,0,0],Using:[We(!0,!0,!0),Te(10,.2)],Children:[{Rotation:[0,1,0,0],Using:[pe(e.Canvas.width/e.Canvas.height,1,.1,1e3)]}]}}function Ae(e){return(t,r)=>{let n={};for(let i in e){let{Keyframes:t,Flags:r=7}=e[i],a=t[t.length-1].Timestamp;n[i]={Keyframes:t.map(e=>({...e})),Flags:r,Duration:a,Time:0}}t.World[r]|=64,t[6][r]={States:n,Current:n[1]}}}function Le(e){return(t,r)=>{t.World[r]|=32,t[5][r]={Idle:e,Time:0}}}function ve(e=!0,t=[1,1,1]){return(r,n)=>{r.World[n]|=1024,r[10][n]={EntityId:n,New:!0,Dynamic:e,Size:t,Min:[0,0,0],Max:[0,0,0],Center:[0,0,0],Half:[0,0,0],Collisions:[]}}}function Ie(e=[1,1,1],t=1){return(r,n)=>{r.World[n]|=16,r[4][n]={EntityId:n,Color:e,Intensity:t**2}}}function xe(e,t,r){return(n,i)=>{Yt.has(t)||Yt.set(t,Se(n.GL,t)),n.World[i]|=4,n[2][i]={Kind:1,Material:e,VAO:Yt.get(t),Count:t.Indices.length,Color:r}}}function Se(e,t){let r=e.createVertexArray();return e.bindVertexArray(r),e.bindBuffer(we,e.createBuffer()),e.bufferData(we,t.Vertices,Ee),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,Ke,!1,0,0),e.bindBuffer(we,e.createBuffer()),e.bufferData(we,t.Normals,Ee),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,3,Ke,!1,0,0),e.bindBuffer(Re,e.createBuffer()),e.bufferData(Re,t.Indices,Ee),e.bindVertexArray(null),r}function Pe(e=!0){return(t,r)=>{t.World[r]|=2048,t[11][r]={Dynamic:e,VelY:0,AccY:0}}}const be=0,De=2,Ge=4,Ee=35044,we=34962,Re=34963,He=35632,Ye=35633,Be=35713,Fe=35714,qe=5123,Ke=5126;let Ne=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;

    layout(location=${1}) in vec3 position;

    void main() {
        gl_Position = pv * world * vec4(position, 1.0);
    }
`,Oe=`#version 300 es
    precision mediump float;
    uniform vec4 color;

    out vec4 frag_color;

    void main() {
        frag_color = color;
    }
`,ke=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;
    uniform mat4 self;
    uniform vec4 color;
    uniform int light_count;
    uniform vec3 light_positions[10];
    uniform vec4 light_details[10];

    layout(location=${1}) in vec3 position;
    layout(location=${2}) in vec3 normal;
    flat out vec4 vert_color;

    void main() {
        vec4 world_pos = world * vec4(position, 1.0);
        vec3 world_normal = normalize((vec4(normal, 0.0) * self).xyz);
        gl_Position = pv * world_pos;

        vec3 rgb = vec3(0.0, 0.0, 0.0);
        for (int i = 0; i < light_count; i++) {
            vec3 light_dir = light_positions[i] - world_pos.xyz ;
            vec3 light_normal = normalize(light_dir);
            float light_dist = length(light_dir);

            float diffuse_factor = max(dot(world_normal, light_normal), 0.0);
            float distance_factor = light_dist * light_dist;
            float intensity_factor = light_details[i].a;

            rgb += color.rgb * light_details[i].rgb * diffuse_factor
                    * intensity_factor / distance_factor;
        }

        vert_color = vec4(rgb, 1.0);
    }
`,je=`#version 300 es
    precision mediump float;

    flat in vec4 vert_color;
    out vec4 frag_color;

    void main() {
        frag_color = vert_color;
    }
`,ze=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;
    uniform mat4 self;
    uniform vec4 color;
    uniform int light_count;
    uniform vec3 light_positions[10];
    uniform vec4 light_details[10];

    layout(location=${1}) in vec3 position;
    layout(location=${2}) in vec3 normal;
    out vec4 vert_color;

    void main() {
        vec4 world_pos = world * vec4(position, 1.0);
        vec3 world_normal = normalize((vec4(normal, 1.0) * self).xyz);
        gl_Position = pv * world_pos;

        vec3 rgb = vec3(0.0, 0.0, 0.0);
        for (int i = 0; i < light_count; i++) {
            vec3 light_dir = light_positions[i] - world_pos.xyz ;
            vec3 light_normal = normalize(light_dir);
            float light_dist = length(light_dir);

            float diffuse_factor = max(dot(world_normal, light_normal), 0.0);
            float distance_factor = light_dist * light_dist;
            float intensity_factor = light_details[i].a;

            rgb += color.rgb * light_details[i].rgb * diffuse_factor
                    * intensity_factor / distance_factor;
        }

        vert_color = vec4(rgb, 1.0);
    }
`,Qe=`#version 300 es
    precision mediump float;

    in vec4 vert_color;
    out vec4 frag_color;

    void main() {
        frag_color = vert_color;
    }
`,Xe=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;
    uniform mat4 self;

    layout(location=${1}) in vec3 position;
    layout(location=${2}) in vec3 normal;
    out vec4 vert_pos;
    out vec3 vert_normal;

    void main() {
        vert_pos = world * vec4(position, 1.0);
        vert_normal = (vec4(normal, 1.0) * self).xyz;
        gl_Position = pv * vert_pos;
    }
`,$e=`#version 300 es
    precision mediump float;

    uniform vec4 color;
    uniform int light_count;
    uniform vec3 light_positions[10];
    uniform vec4 light_details[10];

    in vec4 vert_pos;
    in vec3 vert_normal;
    out vec4 frag_color;

    void main() {
        vec3 rgb = vec3(0.0, 0.0, 0.0);
        vec3 frag_normal = normalize(vert_normal);
        for (int i = 0; i < light_count; i++) {
            vec3 light_dir = light_positions[i] - vert_pos.xyz;
            vec3 light_normal = normalize(light_dir);
            float light_dist = length(light_dir);

            float diffuse_factor = max(dot(frag_normal, light_normal), 0.0);
            float distance_factor = light_dist * light_dist;
            float intensity_factor = light_details[i].a;
            float attenuation = distance_factor / intensity_factor;

            rgb += color.rgb * light_details[i].rgb * diffuse_factor / attenuation;
        }

        frag_color = vec4(rgb, 1.0);
    }
`,Je=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;

    layout(location=${1}) in vec3 position;

    void main() {
        gl_Position = pv * world * vec4(position, 1.0);
        gl_PointSize = 2.0;
    }
`,Ze=`#version 300 es
    precision mediump float;
    uniform vec4 color;

    out vec4 frag_color;

    void main() {
        frag_color = color;
    }
`,et=`#version 300 es
    uniform mat4 pv;
    uniform mat4 world;

    layout(location=${1}) in vec3 position;

    void main() {
        gl_Position = pv * world * vec4(position, 1.0);
    }
`,tt=`#version 300 es
    precision mediump float;
    uniform vec4 color;

    out vec4 frag_color;

    void main() {
        frag_color = color;
    }
`;const rt=1e-6,nt=66;let it;const at=32,ot=10,lt=1026,st=[[.5,.5,.5],[.5,.5,-.5],[-.5,.5,-.5],[-.5,.5,.5],[.5,-.5,.5],[.5,-.5,-.5],[-.5,-.5,-.5],[-.5,-.5,.5]];let dt=new WeakMap;const ut={Vertices:Float32Array.from([-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5]),Indices:Uint16Array.from([23,22,20,22,21,20,19,18,16,18,17,16,15,14,12,14,13,12,11,10,8,10,9,8,7,6,4,6,5,4,3,2,0,2,1,0]),Normals:Float32Array.from([-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0])},mt=new Map;let ft=document.getElementById("tick"),ct=document.getElementById("fps");const gt=18,yt=514,ht=3074,Ct=-9.81,pt=768,Tt=[1,0,0],Wt=[0,1,0],Mt=6,At=2,Lt=5122;let vt,It=document.querySelector("main");var xt,St,Pt,Vt,Ut,bt,Dt,Gt,Et,_t,wt,Rt;xt=1,St=2,Pt=3,Vt=4,Ut=5,bt=6,Dt=7,Gt=9,Et=8,_t=10,wt=11,Rt=12;const Ht={Keyframes:[{Timestamp:0,Scale:[1,1,1],Ease:Ce},{Timestamp:1,Scale:[.8,.8,.8],Ease:Ce}]};let Yt=new WeakMap;const Bt={Vertices:Float32Array.from([0,-.5,0,.223605,-.425327,.154506,-.085408,-.425327,.249998,.380422,-.22361,.262863,.447211,-.262868,0,-.276392,-.425326,0,-.085408,-.425327,-.249998,.223605,-.425327,-.154506,.5,0,.154506,-.145306,-.22361,.425325,.138198,-.262869,.404506,0,0,.5,-.470227,-.223608,0,-.361802,-.262868,.249998,-.5,0,.154506,-.145306,-.22361,-.425325,-.361802,-.262868,-.249998,-.309017,0,-.404508,.380422,-.22361,-.262863,.138198,-.262869,-.404506,.309017,0,-.404508,.309017,0,.404508,-.309017,0,.404508,-.5,0,-.154506,0,0,-.5,.5,0,-.154506,.145306,.22361,.425325,.361802,.262868,.249998,.085408,.425327,.249998,-.380422,.22361,.262863,-.138198,.262869,.404506,-.223605,.425327,.154506,-.380422,.22361,-.262863,-.447211,.262868,0,-.223605,.425327,-.154506,.145306,.22361,-.425325,-.138198,.262869,-.404506,.085408,.425327,-.249998,.470227,.223608,0,.361802,.262868,-.249998,.276392,.425326,0,0,.5,0]),Indices:Uint16Array.from([38,39,25,40,39,38,40,38,27,38,25,8,27,38,8,27,8,21,21,8,3,25,4,8,8,4,3,4,1,3,25,18,4,7,1,4,18,7,4,23,14,12,23,12,16,15,16,6,19,15,6,19,6,7,18,19,7,39,20,25,25,20,18,20,19,18,39,35,20,24,15,19,24,19,20,35,24,20,23,16,17,24,17,15,17,16,15,32,23,17,36,32,17,36,17,24,35,36,24,37,35,39,37,39,40,37,36,35,41,37,40,34,32,36,34,36,37,41,34,37,33,14,23,32,33,23,34,33,32,33,29,14,31,29,33,31,33,34,41,31,34,40,27,28,41,40,28,41,28,31,26,27,21,28,27,26,28,26,30,28,30,31,31,30,29,29,22,14,29,30,22,26,21,11,30,26,11,30,11,22,10,3,1,21,3,10,21,10,11,22,11,9,11,10,9,22,9,13,22,13,14,14,13,12,12,13,5,16,12,5,16,5,6,10,1,2,9,10,2,13,9,2,13,2,5,7,0,1,7,6,0,6,5,0,5,2,0,2,1,0]),Normals:Float32Array.from([0,-1,0,.4115,-.8568,.3107,-.1564,-.8515,.5004,.7095,-.4566,.5367,.8415,-.5402,0,-.5101,-.8601,0,-.1564,-.8515,-.5004,.4115,-.8568,-.3107,.9474,-4e-4,.3199,-.2662,-.4485,.8532,.2529,-.5271,.8113,0,0,1,-.887,-.4617,0,-.6736,-.5351,.5098,-.9474,4e-4,.3199,-.2662,-.4485,-.8532,-.6736,-.5351,-.5098,-.5727,-5e-4,-.8197,.7095,-.4566,-.5367,.2529,-.5271,-.8113,.5727,5e-4,-.8197,.5727,5e-4,.8197,-.5727,-5e-4,.8197,-.9474,4e-4,-.3199,0,0,-1,.9474,-4e-4,-.3199,.2662,.4485,.8532,.6736,.5351,.5098,.1564,.8515,.5004,-.7095,.4566,.5367,-.2529,.5271,.8113,-.4115,.8568,.3107,-.7095,.4566,-.5367,-.8415,.5402,0,-.4115,.8568,-.3107,.2662,.4485,-.8532,-.2529,.5271,-.8113,.1564,.8515,-.5004,.887,.4617,0,.6736,.5351,-.5098,.5101,.8601,0,0,1,0])};let Ft={Tracks:[{Instrument:[7,,,,,,,,[["sine",7,1,1,4,7],["sine",1,1,1,6,7]]],Notes:[72,,,,74,,,,72]}],Exit:2},qt=new class{constructor(){this.World=[],this[xt]=[],this[St]=[],this[Pt]=[],this[Vt]=[],this[Ut]=[],this[bt]=[],this[Dt]=[],this[Gt]=[],this[Et]=[],this[_t]=[],this[wt]=[],this[Rt]=[],this.Audio=new AudioContext,this.Input={mouse_x:0,mouse_y:0},this.ClearColor=[1,.3,.3,1],this.Materials=[],this.Cameras=[],this.Lights=[],this.RAF=0,document.addEventListener("visibilitychange",()=>document.hidden?this.Stop():this.Start()),this.Canvas=document.querySelector("canvas"),this.Canvas.width=window.innerWidth,this.Canvas.height=window.innerHeight,this.Canvas.addEventListener("click",()=>this.Canvas.requestPointerLock()),window.addEventListener("keydown",e=>this.Input[e.code]=1),window.addEventListener("keyup",e=>this.Input[e.code]=0),this.Canvas.addEventListener("mousedown",e=>this.Input[`mouse_${e.button}`]=1),this.Canvas.addEventListener("mouseup",e=>this.Input[`mouse_${e.button}`]=0),this.Canvas.addEventListener("mousemove",e=>{this.Input.mouse_x=e.movementX,this.Input.mouse_y=e.movementY}),this.GL=this.Canvas.getContext("webgl2"),this.GL.enable(2929),this.GL.enable(2884),this.GL.frontFace(2304),this.Materials[0]=y(this.GL),this.Materials[1]=h(this.GL),this.Materials[2]=m(this.GL),this.Materials[3]=f(this.GL),this.Materials[4]=c(this.GL),this.Materials[5]=g(this.GL)}CreateEntity(e=0){for(let t=0;t<1e4;t++)if(!this.World[t])return this.World[t]=e,t;throw new Error("No more entities available.")}FixedUpdate(e){let t=performance.now();re(this,e),P(this,e),Q(this,e),le(this),ue(this),w(this),ee(this,e),le(this),Z(this,performance.now()-t,document.querySelector("#fixed")),K(this)}FrameUpdate(e){let t=performance.now();D(this,e),E(this),j(this),ie(this),k(this,e),he(),Z(this,performance.now()-t,document.querySelector("#frame"))}Start(){let e=1/60,t=0,r=performance.now(),n=i=>{let a=(i-r)/1e3;t+=a;let o=t/e;for(this.Input.mouse_x/=o,this.Input.mouse_y/=o;t>e;)t-=e,this.FixedUpdate(e);this.FrameUpdate(a),r=i,this.Input.mouse_x=0,this.Input.mouse_y=0,this.RAF=requestAnimationFrame(n)};this.Stop(),this.Audio.resume(),n(r)}Stop(){this.Audio.suspend(),cancelAnimationFrame(this.RAF)}Add({Translation:e,Rotation:t,Scale:r,Using:n=[],Children:i=[]}){let a=this.CreateEntity(1);l(e,t,r)(this,a);for(let o of n)o(this,a);let o=this[1][a];for(let a of i){let e=this.Add(a),t=this[1][e];t.Parent=o,o.Children.push(t)}return a}Destroy(e){let t=this.World[e];if(1&t)for(let t of this[1][e].Children)this.Destroy(t.EntityId);this.World[e]=0}};(function(e){e.World=[],e.Cameras=[],e.Lights=[],e.GL.clearColor(1,.3,.3,1),e.Add({Translation:[0,0,5],...Me(e)}),e.Add({Translation:[0,-2,0],Scale:[10,1,10],Using:[xe(e.Materials[4],ut,[1,1,.3,1]),ve(!1),Pe(!1)]}),e.Add({Translation:[0,3,5],Using:[Ie([1,1,1],5),Le(Ft)]}),e.Add({Translation:[-2,5,0],Using:[F(e.Materials[0],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]}),e.Add({Translation:[0,5,0],Using:[F(e.Materials[1],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]}),e.Add({Translation:[2,5,0],Using:[F(e.Materials[2],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]}),e.Add({Translation:[-2,1,0],Using:[xe(e.Materials[3],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]}),e.Add({Translation:[0,1,0],Using:[xe(e.Materials[4],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]}),e.Add({Translation:[2,1,0],Using:[xe(e.Materials[5],Bt,[1,1,.3,1]),ve(!0),Pe(!0),Ae({[1]:Ht})]})})(qt),qt.Start(),window.$=(...t)=>e(qt,...t),window.game=qt})();
